---
category: DB
title: sql复杂查询
author: smona
published: true
date: '2017-04-13 11:13:37'
layout: post
---
# 前言
　　前面的一篇文章写了下[数据库设计和SQL语句基础](%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E5%92%8CSQL%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80)，里面都是简单的增删改查，而且对最重要的**查询**也没有深入研究，实在是罪过，那么本文就sql复杂的查询语句进行探讨，也是当作一个记录好了

# No.1
假设我们现在有张这样的成绩表grade

| name | class | score |
| ------| ------ | ------ |
| 光头 | 语文 | 9 |
| 吴克 | 语文 | 100 |
| 光头 | 物理 | 99 |
| 吴克 | 物理 | 7 |
| 光头 | 体育 | 100 |
| 吴克 | 体育 | 5 |

现在我们要求不及格(score<60)科目大于等于2门的那个人的平均分，一条sql解决?  

先post答案：
```sql
SELECT name,AVG(score) 
FROM grade
WHERE name IN (SELECT name FROM grade WHERE score<60 GROUP BY name HAVING COUNT(score)>=2)
GROUP BY name;
```

现在来理解上面这么一串东西

0. 首先要知道sql执行顺序是: FROM=>WHERE(IN)=>GROUP BY=>HAVING=>SELECT

先看外层的： 
1. **FROM grade**

| name | class | score |
|--|--|--|
|光头|	语文|	9|
|吴克|	语文|	100|
|光头|	物理|	99|
|吴克|	物理|	7|
|光头|	体育|	100|
|吴克|	体育|	5|

**2. WHERE name IN ( SELECT name FROM grade WHERE score<60 GROUP BY name HAVING COUNT(score)>=2)** 
筛选出括号内所查出的不及格的科目数目大于等于2的那些人

-2.0括号内:
 -2.1 FROM score,我们可以得到原来的表

| name | class | score |
|--|--|--|
|光头|	语文|	9|
|吴克|	语文|	100|
|光头|	物理|	99|
|吴克|	物理|	7|
|光头|	体育|	100|
|吴克|	体育|	5|

2.2 WHERE　score<60，我们可以筛出score<60的项

| name | class | score |
|--|--|--|
|光头|	语文|	9|
|吴克|	物理|	7|
|吴克|	体育|	5|

2.3 GROUP BY name，有点像依据学生姓名来归档放在一起并合并了单元格，**GROUP BY简单来说是建立组**，关于GROUP BY[2]会讲的更加好理解  
![这里写图片描述](http://img.blog.csdn.net/20170413105554756?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjkyNDUwOTc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

2.4 HAVING COUNT(score)>=2,HAVING的作用和WHERE很像都是筛选，不过WHERE不能带聚合函数的(比如SVG,SUM,COUNT等等)，**HAVING是用来筛选组的**，所以往往和GROUP BY配合出现  
![这里写图片描述](http://img.blog.csdn.net/20170413105928504?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjkyNDUwOTc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

2.5 SELECT name,根据2.4就知道这里的返回的自然就只有`吴克`了

所以WHERE name IN (吴克)，name的取值只能是`吴克`，那么2这一步最后得到`吴克`所有科目的成绩

| name | class | score |
|--|--|--|
|吴克|	语文|	100|
|吴克|	物理|	7|
|吴克|	体育|	5|

3. 再GROUP BY name 
![这里写图片描述](http://img.blog.csdn.net/20170413110937107?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjkyNDUwOTc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
4. 最后SELECT name,AVG(score),我们就可以球的我们这位挂课数目在2门以上的吴克同学的平均分了

|name|	AVG(score)|
|--|--|
|吴克|	37.3333|

Reference:  
[1][十步完全理解 SQL](https://segmentfault.com/a/1190000000385739)  
[2][可以这样去理解group by和聚合函数](http://www.cnblogs.com/wuguanglei/p/4229938.html)
