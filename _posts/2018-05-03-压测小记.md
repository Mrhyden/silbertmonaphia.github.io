---
published: true
categories: OS
---
# 前言  
　　以前只是知道要写单元测试，或者接口测试，而对压测只是停留在知道的程度，直到最近有了某个接口的压测需求，才开坑压测，本来想着稍微学学，满足需求即可，但是没想到压测已经是一门学问，要了解和学习的东西并不只是所看到的冰山一角
  
#　压力源
　　说到压力源，就是模拟用户的地方，因为不太可能用真是用户去并发请求一个借口，所以就有很多模拟用户的工具，比如ab,wrk，jmeter或者是现在公司用的locust,中文名是蝗虫，其实可以发起网络请求的都可以做压测，所以我见过有用curl或者python的requests库做压测的，但是还是比不上专用的压测工具，为什么呢？这是因为一方面专用的压测工具本身就打包了很多压测过程中会用到的特性，另一面，压测工具对于压测机单机资源利用程度比较高，就拿locust来说，基于协程的设计让他的压力产生在所有的压测工具中脱颖而出，这也是公司选择locus的原因之一，就同等的机器，locust能模拟更多的并发
  
#　服务器资源  
  我原本以为只要学习locust就知道怎么压测了，但是没想到的是locust只是压，如果不去记录被压机硬件配置和观察压力下的被压机的资源状况，只会用locust是没有什么效果的，locust只是从用户的角度看问题，顶多算是个黑盒测试，locust只能获取调用接口的成功数，失败数，每秒请求量，接口最高并发量等，但是对于测出最高并发量没有达到预期要求的情况，这明显就是不够的，所以就要看看服务器资源在被压力源施压下的变化，这就需要一些服务器资源搜集工具了  
  我这里就直接以linux为前提了，其实linux很多系统资源信息都在/proc这个目录下，而比如lscpu,vmstat这些个命令其实也是基于/proc这个目录提供的信息进一步包装的，所以你如果熟悉linux和C/C++的话，完全可以按照自己的需求根据/proc写一套自己的系统资源搜集套件～
  
# 服务器配置信息  
CPU: lscpu  
Memory: free -h  
Disk: df -h  
Network: ifonfig  
OS: lsb_release -a 或者 uname -a

# 服务器实时资源信息  
  linux获取资源实时信息有一堆的命令，简直看到眼花，但是我今天总结了一天，其实发现实用的就几个，htop/top,dstat,netstat
  htop是top的升级版，能用htop就用htop，top毕竟太老，有很多特性不支持，比如移动选择进程，直接在界面杀掉进程等，而且htop界面很漂亮，尽管top是原生带有的不用安装，但是还是在你的server上装一个htop吧  
  dstat则是vmstat, iostat and ifstat的合集，一般都是直接用`dstat -cdlmnpsy`  
  netstat提出来主要是看TIME_WAIT等连接状态的统计,着重网络方面异常的发现  

P.s.特别要注意数据库性能方面,这个要单独拿出来讲，比如mysql，可以查看相关variable和status值，还可以打开慢查询记录，分析一些慢查询语句等(数据库性能方面相对有点复杂，待补充...)

# Netdata
  上面的是手动一个个去看CPU，内存，磁盘，IO等资源状况，那么对于我们分析性能而言，其实更加希望的是这些资源状况信息的一个汇集，那么[netdata](!https://github.com/firehol/netdata)就是这么一个工具，而且它资源占用极少(甚至开了KSM以后还能再节省40-60%的内存资源)，dashboard的界面酷炫，并且它是实时的!虽然保存不便，但是实时这点对我们分析实在帮助很大，所以也就不计较保存的不便了，有志者可以提PR改进netdata的保存数据的功能哈
  当然，除了做压测以外，本身netdata就可以做服务器资源监控和报警，这个是和一些云服务的监控类似，而基于netdata本身提供的RESTful api，我们又可以重新定制这些监控数据，简直不能再好～
  P.s.netdata还能接入比如redis,mysql,postgresql,rabbitMQ,kafka,nginx等常见应用的监控